name: Test
on: [push]

jobs:
  image_builder:
    name: Build image
    env:
      IMAGE_BUILDER_IMAGE: docker.pkg.github.com/mvgijssel/setup/image-builder
      IMAGE_SHA_TAG: ${{ github.sha }}
      DOCKER_BUILDKIT: 1
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v1

    - env:
        GITHUB: ${{ toJson(github) }}
        ENV: ${{ toJson(env) }}
        JOB: ${{ toJson(job) }}
        STEPS: ${{ toJson(steps) }}
        RUNNER: ${{ toJson(runner) }}
        SECRETS: ${{ toJson(secrets) }}
        STRATEGY: ${{ toJson(strategy) }}
        MATRIX: ${{ toJson(matrix) }}
      run: |
        env

    - name: Test qemu
      if: always()
      run: |
        qemu-img --help

    - name: Login to GitHub docker registry
      run: |
        docker login -u mvgijssel -p ${{ secrets.GITHUB_TOKEN }} docker.pkg.github.com

    - name: Build the image builder
      run: |
        export IMAGE_BRANCH_TAG=$(echo ${{ github.ref }} | tr "/" _)

        docker pull ${IMAGE_BUILDER_IMAGE}:latest || true
        docker pull ${IMAGE_BUILDER_IMAGE}:${IMAGE_BRANCH_TAG} || true

        docker build \
          --tag ${IMAGE_BUILDER_IMAGE}:${IMAGE_BRANCH_TAG} \
          --tag ${IMAGE_BUILDER_IMAGE}:${IMAGE_SHA_TAG} \
          --file kubernetes/Dockerfile \
          kubernetes

        docker push ${IMAGE_BUILDER_IMAGE}:${IMAGE_BRANCH_TAG}
        docker push ${IMAGE_BUILDER_IMAGE}:${IMAGE_SHA_TAG}

    - name: Build the Kubernetes image
      run: |
        docker run \
          --rm \
          --privileged \
          --volume $PWD/kubernetes/images:/app \
          --volume $PWD/kubernetes/elements:/elements \
          --env DIB_RELEASE=stretch \
          --env DIB_APT_MINIMAL_CREATE_INTERFACES=0 \
          ${IMAGE_BUILDER_IMAGE}:${IMAGE_SHA_TAG} \
          disk-image-create -o kubernetes_stretch debian vm debian-networking-fix cloud-init-fix kubernetes growroot qemu-guest nfs resolvconf goss

    - name: Test the Kubernetes image
      run: |
        kubernetes/boot_qemu.sh

  test1:
    name: Test 1
    runs-on: macos-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v1

    - name: Test action
      if: always()
      uses: ./

    - name: Test qemu
      if: always()
      run: |
        qemu-img --help

    - name: Test brew
      if: always()
      run: |
        brew info

    - name: Test docker
      if: always()
      run: |
        docker info

    - uses: actions/checkout@v1
      with:
        ref: ${{ matrix.ref }}
