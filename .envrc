export GITHUB_DOCKER_REGISTRY_URL=docker.pkg.github.com/mvgijssel/setup
export DOCKER_REGISTRY_URL="${GITHUB_DOCKER_REGISTRY_URL}"
export BASE_IMAGE=base-image
export IMAGE_BUILDER_IMAGE=image-builder
export RAZOR_SERVER_IMAGE=razor-server
export IPXE_IMAGE=ipxe

export LOCAL_NETWORK_DOMAIN=setup.dev
export LOCAL_NETWORK_BRIDGE_INTERFACE=bridge77
export LOCAL_NETWORK_INTERNET_INTERFACE=en0
export LOCAL_NETWORK_BRIDGE_IP=192.168.4.1
export LOCAL_NETWORK_NETMASK=255.255.255.0
export LOCAL_NETWORK_DHCP_START=192.168.4.100
export LOCAL_NETWORK_DHCP_END=192.168.4.200

export LIBVIRT_FQDN="libvirt.$LOCAL_NETWORK_DOMAIN"
export TF_VAR_libvirt_fqdn="$LIBVIRT_FQDN"
export TF_VAR_parent_domain="$LOCAL_NETWORK_DOMAIN"

# Only if the CI variable does not exist
# If NOT on the CI, executing on local machine
if [ -z "${CI+x}" ]; then
  export CI=false
fi

export CI_SEMAPHORE=false
export CI_GITHUB=false

if [[ "${CI}" = true ]]; then
  export CI=true

  # If NOT semaphore ci use the Github ref
  if [ -z "${SEMAPHORE_GIT_REF+x}" ]; then
      export GIT_REF="${GITHUB_REF}"
      export CI_GITHUB=true
  else
      export GIT_REF="${SEMAPHORE_GIT_REF}"
      export CI_SEMAPHORE=true
  fi

  export GOPATH="$HOME/go"

  TF_CLI_ARGS="-var-file=ci.tfvars -input=false"

  # Disable checking for hosts key on the CI
  export ANSIBLE_HOST_KEY_CHECKING=False
else
  export CI=false

  # Only set the GITHUB REF locally (not in the CI)
  export GIT_REF="refs/heads/$(git rev-parse --abbrev-ref HEAD)"

  # Setting for diskimage-builder, will trigger a bash repl when there is an error
  export break=after-error

  TF_CLI_ARGS="-var-file=local.tfvars -input=false"

  export ANSIBLE_HOST_KEY_CHECKING=True
fi

export DOCKER_BUILDKIT=0

# export IP_ADDRESS=$(ipconfig getifaddr en0)

export SETUP_ROOT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"
export SETUP_SCRIPTS_DIR="${SETUP_ROOT_DIR}/scripts"
export SETUP_LOG_DIR="${SETUP_ROOT_DIR}/log"
export SETUP_IMAGE_DIR="${SETUP_ROOT_DIR}/image"
export SETUP_BOX_DIR="${SETUP_ROOT_DIR}/box"
export SETUP_IPXE_DIR="${SETUP_ROOT_DIR}/ipxe"
export SETUP_TMP_DIR="${SETUP_ROOT_DIR}/tmp"
export SETUP_KUBERNETES_DIR="${SETUP_ROOT_DIR}/kubernetes"
export SETUP_UNIFI_DIR="${SETUP_ROOT_DIR}/unifi"
export SETUP_RAZOR_SERVER_DIR="${SETUP_ROOT_DIR}/razor-server"
export SETUP_DEPLOY_IMAGE_DIR="${SETUP_ROOT_DIR}/deploy-image"
export SETUP_IMAGE_BUILDER_DIR="${SETUP_ROOT_DIR}/image-builder"
export SETUP_ELEMENTS_DIR="${SETUP_ROOT_DIR}/elements"
export SETUP_LIBVIRT_DIR="${SETUP_ROOT_DIR}/libvirt"
export SETUP_DNSMASQ_DIR="${SETUP_ROOT_DIR}/dnsmasq"
export SETUP_SECRETS_DIR="${SETUP_ROOT_DIR}/secrets"

export PUBLIC_KEY_PATH="$SETUP_SECRETS_DIR/id_rsa.development.pub"
export TF_VAR_public_key_path="${PUBLIC_KEY_PATH}"

export TF_VAR_setup_kubernetes_dir="${SETUP_KUBERNETES_DIR}"
export TF_VAR_setup_root_dir="${SETUP_ROOT_DIR}"
export TF_VAR_setup_razor_server_dir="${SETUP_RAZOR_SERVER_DIR}"
export TF_VAR_setup_secrets_dir="${SETUP_SECRETS_DIR}"

# TODO: can solve this with Terragrunt instead
export TF_CLI_ARGS_plan="${TF_CLI_ARGS}"
export TF_CLI_ARGS_apply="${TF_CLI_ARGS}"
export TF_CLI_ARGS_destroy="${TF_CLI_ARGS}"
export TF_CLI_ARGS_console="${TF_CLI_ARGS}"
export TF_CLI_ARGS_refresh="${TF_CLI_ARGS}"



# Ensure gnutar tar binary is in front of the path
export PATH=\
"${SETUP_SCRIPTS_DIR}:"\
"/usr/local/opt/gnu-tar/libexec/gnubin:"\
"${PATH}"
