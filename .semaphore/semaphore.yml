version: v1.0
name: Initial Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

auto_cancel:
  running:
    when: "true"

blocks:
  - name: Test
    task:
      jobs:
        - name: Test libvirt
          commands:
            - checkout
            - source .envrc
            - ./libvirt/setup_semaphoreci.sh
            - docker_build.sh "${BASE_IMAGE}" "./base-image"
            - docker_build.sh "${IMAGE_BUILDER_IMAGE}" "./image-builder"
            - image_build.sh ./kubernetes/image.cfg
            - cd libvirt
            - terraform apply -auto-approve
            - ansible-playbook -i ../scripts/terraform.py ../kubernetes/setup_cluster.yml
      epilogue:
        always:
          commands:
            - artifact push job $SETUP_LOG_DIR
      secrets:
        - name: GITHUB_DOCKER_REGISTRY_TOKEN
    dependencies: []
