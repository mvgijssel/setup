# frozen_string_literal: true

log_dir = ENV.fetch('SETUP_LOG_DIR')
bridge_adapter = ENV.fetch('VAGRANT_BRIDGE_ADAPTER')
ipxe_dir = ENV.fetch('SETUP_IPXE_DIR')

# -*- mode: ruby -*-
# vi: set ft=ruby :

# All Vagrant configuration is done below. The "2" in Vagrant.configure
# configures the configuration version (we support older styles for
# backwards compatibility). Please don't change it unless you know what
# you're doing.
Vagrant.configure('2') do |config|
  config.vm.synced_folder '.', '/vagrant', disabled: true

  config.vm.define "razor-server", primary: true do |razor|
    razor.vm.network "public_network", bridge: bridge_adapter
    razor.vm.network "forwarded_port", guest: 8150, host: 8150

    razor.vm.box = 'file://razor-server.box'

    razor.vm.synced_folder "../deploy-image/images/deploy-image", "/repo/deploy-image"
    razor.vm.synced_folder "../libvirt/images/libvirt", "/repo/libvirt"
    razor.vm.synced_folder "./elements/razor-server/static/tasks/deploy-image.task", "/tasks/deploy-image.task"
    razor.vm.synced_folder File.join(ipxe_dir, "output"), "/tftpboot/ipxe"

    razor.vm.hostname = 'razor-server'

    razor.vm.provider 'virtualbox' do |vb|
      vb.gui = false
      vb.memory = "1024"
      vb.customize ["modifyvm", :id, "--uart1", "0x3f8", "4"]
      vb.customize ["modifyvm", :id, "--uartmode1", "file", File.join(log_dir, "razor-server.log")]
    end
  end

  config.vm.define "pxe", autostart: false do |pxe|
    bridge_mac = '08:00:27:cf:12:58'
    vbox_bridge_mac = bridge_mac.split(':').join
    pxe.vm.network "public_network", bridge: bridge_adapter, mac: vbox_bridge_mac

    # pxe.trigger.before :up do |t|
    #   t.info = "Registring PXE machine with razor-server"
    #   t.run = { inline: "./razor-register-pxe.sh '#{bridge_mac}'" }
    # end

    pxe.vm.box = 'file://pxe.box'
    pxe.vm.graceful_halt_timeout = 0

    pxe.vm.provider 'virtualbox' do |vb|
      vb.gui = false

      # We need a lot of memory here because a disk is downloaded and extracted into ram
      vb.memory = "4096"

      # Setup the serial port for logging
      vb.customize ["modifyvm", :id, "--uart1", "0x3f8", "4"]
      vb.customize ["modifyvm", :id, "--uartmode1", "file", File.join(log_dir, "pxe.log")]

      # Make sure the bridged network adapter is used for PXE
      # 0 is the lowest priority, 1 is the highest priority
      vb.customize ["modifyvm", :id, "--nicbootprio1", "0"]
      vb.customize ["modifyvm", :id, "--nicbootprio2", "1"]

      # Don't pass the domain name of the host DNS
      vb.customize ["modifyvm", :id, "--natdnspassdomain1", "off"]

      # Attach iPXE to the Floppy controller to enable network booting
      vb.customize ["storageattach", :id, "--storagectl", "Floppy", "--port", 0, "--device", 0, "--type", "fdd", "--medium", File.join(ipxe_dir, "output/ipxe.dsk")]
    end
  end
end
