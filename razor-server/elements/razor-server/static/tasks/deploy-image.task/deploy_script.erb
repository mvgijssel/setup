#!/bin/bash

set -Eoux pipefail

DISK_URL="<%= node.metadata['DISK_URL'] %>"
TARGET_DISK="<%= node.metadata['TARGET_DISK'] %>"

curl <%= log_url("Start deploy_script") %>

DISK_QCOW="disk.qcow2"
DISK_RAW="disk.raw"

curl <%= log_url("Starting to download disk from '$DISK_URL'") %>

# Download the disk
curl -L $DISK_URL -o $DISK_QCOW

curl <%= log_url("Downloaded disk successfully") %>

curl <%= log_url("Starting converting of the qcow to raw") %>

# Convert the qcow2 image to raw
qemu-img convert -f qcow2 -O raw $DISK_QCOW $DISK_RAW

curl <%= log_url("Done converting qcow to raw") %>

curl <%= log_url("Start writing #{node.metadata['DISK_URL']} to #{node.metadata['TARGET_DISK']}") %>

dd if=$DISK_RAW ibs=1M | pv | dd of=$TARGET_DISK obs=1M

curl <%= log_url("Done writing #{node.metadata['DISK_URL']} to #{node.metadata['TARGET_DISK']}") %>

curl <%= stage_done_url("deploy_script") %>

# TODO: call the following to indicate to razor the installation finished
# curl <%= stage_done_url("finished") %>
