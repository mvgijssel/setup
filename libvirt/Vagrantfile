# frozen_string_literal: true
# https://www.thomas-krenn.com/en/wiki/Network_Configuration_in_VirtualBox

require 'open3'
require 'net/ssh'

TMP_DIR = ENV.fetch('SETUP_TMP_DIR')
log_dir = ENV.fetch('SETUP_LOG_DIR')
box_dir = ENV.fetch('SETUP_BOX_DIR')
root_dir = ENV.fetch('SETUP_ROOT_DIR')
secrets_dir = ENV.fetch('SETUP_SECRETS_DIR')
scripts_dir = ENV.fetch('SETUP_SCRIPTS_DIR')
libvirt_dir = ENV.fetch('SETUP_LIBVIRT_DIR')
razor_server_dir = ENV.fetch('SETUP_RAZOR_SERVER_DIR')

ssh_config = File.join(scripts_dir, 'ssh_config')
private_key_path = Net::SSH::Config.load(ssh_config, '*').fetch('identityfile')
dnsmasq_host_port = ENV.fetch('VAGRANT_BASTION_HOST_PORT')

def build_cloud_init_iso(iso_name, user_data_file, network_config_file)
  iso_location = File.join(TMP_DIR, iso_name)

  Dir.mktmpdir(nil, "/tmp") do |local_tmp_dir|
    user_data = File.join(local_tmp_dir, 'user-data')
    meta_data = File.join(local_tmp_dir, 'meta-data')
    network_config = File.join(local_tmp_dir, 'network-config')

    File.write(user_data, File.read(user_data_file))
    File.write(meta_data, "# Auto-Generated - DO NOT CHANGE THIS")
    File.write(network_config, File.read(network_config_file))

    stdout, stderr, status = Open3.capture3("mkisofs -output #{iso_location} -volid cidata -joliet -rock {#{user_data},#{meta_data},#{network_config}}")

    unless status.success?
      puts stdout
      puts stderr

      raise "Unable to create cloud-init iso '#{name}'"
    end
  end

  iso_location
end

Vagrant.configure('2') do |config|
  config.vm.synced_folder '.', '/vagrant', disabled: true
  config.ssh.config = ssh_config
  # We need the private_key_path, because Net::SSH otherwise uses the wrong one breaking vagrant up
  # Vagrant SSH works fine, using the config and ssh alias in scripts/
  config.ssh.private_key_path = private_key_path

  config.vm.define "dnsmasq" do |dnsmasq|
    # Make sure the port is available, don't auto correct if not
    dnsmasq.vm.network "forwarded_port", guest: 22, host: dnsmasq_host_port, id: 'ssh', auto_correct: false
    dnsmasq.vm.network "private_network", auto_config: false, adapter: 2, virtualbox__intnet: true
    dnsmasq.vm.box = "file://#{File.join(box_dir, 'dnsmasq_buster.box')}"
    dnsmasq.ssh.host = 'dnsmasq.dev'

    dnsmasq.vm.provider 'virtualbox' do |vb|
      vb.gui = false
      vb.memory = "1024"

      # Setup the serial port for logging
      vb.customize ["modifyvm", :id, "--uartmode1", "file", File.join(log_dir, "dnsmasq_buster.log")]

      dnsmasq_cloud_init = build_cloud_init_iso(
        "dnsmasq-cloud-init.iso",
        File.join(libvirt_dir, "cloud-init/dnsmasq-user-data.yml"),
        File.join(libvirt_dir, "cloud-init/dnsmasq-network-config.yml"),
      )
      vb.customize ["storageattach", :id, "--storagectl", "IDE Controller", "--port", "0", "--device", "0", "--type", "dvddrive", "--medium", dnsmasq_cloud_init]
    end
  end

  config.vm.define "libvirt", primary: true do |libvirt|
    libvirt.vm.network "private_network", virtualbox__intnet: true, adapter: 1, auto_config: false
    libvirt.vm.box = "file://#{File.join(box_dir, "libvirt_buster.box")}"
    libvirt.vm.synced_folder log_dir, "/data/vms/logs", mount_options: ["dmode=755,fmode=744"]
    libvirt.vm.synced_folder root_dir, "/home/vagrant/setup", mount_options: ["dmode=755,fmode=744"]
    libvirt.vm.synced_folder secrets_dir, "/home/vagrant/setup/secrets", mount_options: ["dmode=755,fmode=0600"]
    libvirt.ssh.host = 'libvirt.dev'

    libvirt.vm.provider 'virtualbox' do |vb|
      vb.gui = false
      vb.memory = "4096"
      vb.cpus = 2

      # Enable promiscious mode on the network adapter to enable bridge networking in the vm
      vb.customize ["modifyvm", :id, "--nicpromisc1", "allow-all"]

      # Setup log file
      vb.customize ["modifyvm", :id, "--uartmode1", "file", File.join(log_dir, "libvirt_buster.log")]

      libvirt_cloud_init = build_cloud_init_iso(
        "libvirt-cloud-init.iso",
        File.join(libvirt_dir, "cloud-init/libvirt-user-data.yml"),
        File.join(libvirt_dir, "cloud-init/libvirt-network-config.yml"),
      )
      vb.customize ["storageattach", :id, "--storagectl", "IDE Controller", "--port", "0", "--device", "0", "--type", "dvddrive", "--medium", libvirt_cloud_init]
    end
  end
end
