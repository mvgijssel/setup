# NOTE: no -e flag here, because that will result in a kernel panic
set -Eoux pipefail

echo "Start remote disk deploy"

DISK_URL=$(get_kernel_parameter DISK_URL)
TARGET_DISK=$(get_kernel_parameter TARGET_DISK)
DISK_QCOW="disk.qcow2"
DISK_RAW="disk.raw"

echo "Starting to download disk from '$DISK_URL'"

# Download the disk
curl -v -L $DISK_URL -o $DISK_QCOW

ls -lh

# Convert the qcow2 image to raw
qemu-img convert -f qcow2 -O raw $DISK_QCOW $DISK_RAW

ls -lh

echo "Writing '$DISK_RAW' to disk '$TARGET_DISK'"

dd if=$DISK_RAW ibs=1M | pv | dd of=$TARGET_DISK obs=1M

echo "Done writing disk!"
